<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cibercapilla Católica - UCN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,200..900;1,200..900&family=Inter:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Crimson Pro', serif; transition: background-color 0.5s ease; }
        .font-sans { font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .light .glass { background: rgba(0, 0, 0, 0.02); border: 1px solid rgba(0, 0, 0, 0.05); }
        
        /* Velas Lindas */
        .candle-container { perspective: 1000px; }
        .candle-body {
            width: 38px;
            height: 100px;
            border-radius: 6px 6px 4px 4px;
            position: relative;
            transition: all 0.7s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .candle-wick {
            width: 2px;
            height: 8px;
            background: #222;
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 2px;
        }

        .candle-flame {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            width: 18px;
            height: 32px;
            background: linear-gradient(to bottom, transparent 0%, #fbbf24 40%, #f59e0b 80%, #ea580c 100%);
            border-radius: 50% 50% 20% 20%;
            filter: blur(0.5px);
            animation: flicker 1.5s ease-in-out infinite alternate;
            transform-origin: bottom center;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.6), 0 0 40px rgba(251, 191, 36, 0.2);
        }

        .candle-flame::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 10px;
            background: rgba(59, 130, 246, 0.6); /* Núcleo azulado */
            border-radius: 50%;
            filter: blur(1px);
        }

        @keyframes flicker {
            0% { transform: translateX(-50%) scale(1) rotate(-1deg); opacity: 0.9; }
            20% { transform: translateX(-50%) scale(1.05) rotate(1deg); }
            40% { transform: translateX(-50%) scale(0.95) rotate(-0.5deg); opacity: 0.8; }
            60% { transform: translateX(-50%) scale(1.1) rotate(1.5deg); }
            80% { transform: translateX(-50%) scale(0.98) rotate(-1.5deg); opacity: 0.9; }
            100% { transform: translateX(-50%) scale(1) rotate(0.5deg); opacity: 1; }
        }

        .hidden-tab { display: none; }
        .active-tab { border-bottom: 2px solid #d97706; color: #d97706; opacity: 1; }
        
        .glow-effect {
            box-shadow: 0 10px 40px -10px rgba(251, 191, 36, 0.3);
        }

        .gospel-highlight {
            border: 1.5px solid #d97706 !important;
            background: rgba(217, 119, 6, 0.08) !important;
            box-shadow: 0 0 15px rgba(217, 119, 6, 0.1);
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 min-h-screen pb-20 overflow-x-hidden">

    <!-- Header -->
    <header class="p-6 max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center border-b border-amber-500/20 mb-8 gap-4">
        <div class="flex items-center gap-3">
            <i data-lucide="cross" class="text-amber-500 w-8 h-8"></i>
            <div>
                <h1 class="text-xl font-bold tracking-tighter uppercase leading-none">Cibercapilla</h1>
                <p class="text-[10px] uppercase tracking-[0.2em] opacity-60 mt-1">UCN - Fidelidad al Evangelio</p>
            </div>
        </div>
        
        <div class="flex gap-4 items-center font-sans">
            <a href="https://ucn.edu.co/consultame" target="_blank" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-full text-xs font-bold transition-all shadow-lg shadow-indigo-500/20">
                <i data-lucide="users" class="w-4 h-4"></i> Asesoría Espiritual
            </a>
            <button id="themeToggle" class="p-2 rounded-full hover:bg-amber-500/10 transition-colors">
                <i data-lucide="sun" id="themeIcon"></i>
            </button>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4">
        <!-- Nav Tabs -->
        <nav class="flex flex-wrap justify-center gap-2 mb-10 font-sans">
            <button onclick="switchTab('altar')" class="nav-btn active-tab flex items-center gap-2 px-5 py-2.5 rounded-full text-xs uppercase tracking-widest opacity-60 hover:opacity-100">
                <i data-lucide="flame" class="w-4 h-4"></i> Altar
            </button>
            <button onclick="switchTab('eucaristia')" class="nav-btn flex items-center gap-2 px-5 py-2.5 rounded-full text-xs uppercase tracking-widest opacity-60 hover:opacity-100">
                <i data-lucide="video" class="w-4 h-4"></i> Eucaristía
            </button>
            <button onclick="switchTab('rosario')" class="nav-btn flex items-center gap-2 px-5 py-2.5 rounded-full text-xs uppercase tracking-widest opacity-60 hover:opacity-100">
                <i data-lucide="sparkles" class="w-4 h-4"></i> Rosario
            </button>
            <button onclick="switchTab('coronilla')" class="nav-btn flex items-center gap-2 px-5 py-2.5 rounded-full text-xs uppercase tracking-widest opacity-60 hover:opacity-100">
                <i data-lucide="heart" class="w-4 h-4"></i> Coronilla
            </button>
            <button onclick="switchTab('misericordia')" class="nav-btn flex items-center gap-2 px-5 py-2.5 rounded-full text-xs uppercase tracking-widest opacity-60 hover:opacity-100">
                <i data-lucide="hand-helping" class="w-4 h-4"></i> Misericordia
            </button>
            <button onclick="switchTab('papa')" class="nav-btn flex items-center gap-2 px-5 py-2.5 rounded-full text-xs uppercase tracking-widest opacity-60 hover:opacity-100">
                <i data-lucide="globe" class="w-4 h-4"></i> Papa
            </button>
            <button onclick="switchTab('biblia')" class="nav-btn flex items-center gap-2 px-5 py-2.5 rounded-full text-xs uppercase tracking-widest opacity-60 hover:opacity-100">
                <i data-lucide="book-open" class="w-4 h-4"></i> Biblia
            </button>
            <button onclick="switchTab('muro')" class="nav-btn flex items-center gap-2 px-5 py-2.5 rounded-full text-xs uppercase tracking-widest opacity-60 hover:opacity-100">
                <i data-lucide="message-square" class="w-4 h-4"></i> Peticiones
            </button>
        </nav>

        <div id="tabContent" class="min-h-[60vh]">
            
            <!-- Tab: Altar -->
            <section id="tab-altar" class="text-center animate-fade-in">
                <!-- Mensaje de Bienvenida -->
                <div class="max-w-3xl mx-auto mb-12 p-6 glass rounded-2xl border-amber-500/10">
                    <p class="text-lg italic font-light leading-relaxed text-amber-100/90">
                        ¡Bienvenidos a la Cibercapilla de la Fundación Universitaria Católica del Norte! Nos complace recibirlos en este espacio virtual dedicado a la reflexión, la oración y el encuentro con la persona adorable de Jesucristo.
                    </p>
                </div>

                <div class="space-y-4 mb-8">
                    <h2 class="text-3xl font-light italic">Altar de Intenciones</h2>
                    <p class="text-[10px] uppercase tracking-[0.3em] opacity-40 font-sans">
                        Haz clic sobre una vela para encenderla y realizar la oración
                    </p>
                </div>

                <div class="flex flex-wrap justify-center gap-12 pt-6" id="candlesGrid">
                    <!-- Candelas generadas por JS -->
                </div>
                <div id="candlePrayer" class="mt-12 p-8 rounded-3xl border glass max-w-xl mx-auto hidden shadow-2xl">
                    <p class="text-xl italic font-light leading-relaxed" id="prayerText"></p>
                </div>
            </section>

            <!-- Tab: Eucaristía -->
            <section id="tab-eucaristia" class="hidden-tab max-w-3xl mx-auto space-y-8 animate-fade-in">
                <div class="p-10 rounded-[3rem] border glass text-center">
                    <i data-lucide="video" class="text-amber-500 mx-auto mb-6 w-12 h-12"></i>
                    <h2 class="text-3xl font-bold mb-4">La Santa Eucaristía</h2>
                    <div class="bg-amber-500/10 p-6 rounded-2xl border border-amber-500/20 mb-8">
                        <p class="text-xl font-bold mb-4">Todos los días - 12:00 m. (Col)</p>
                        <a href="https://www.facebook.com/SoyCatolicaDelNorte" target="_blank" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-full text-sm font-bold transition-all shadow-lg font-sans">
                            Participar en Facebook Live
                        </a>
                    </div>
                    <div class="text-sm opacity-80 leading-relaxed mb-6">
                        "La Eucaristía es fuente y culmen de toda la vida cristiana". Participar de ella es alimentarse del Pan de Vida.
                        
                        Ofrece la Sagrada Eucarístia en acción de gracias a Dios, por alguien especial o por alguna necesidad.

                    </div>
                    <a href="https://encuestas.ucn.edu.co/index.php/819977" target="_blank" class="text-amber-500 font-bold text-sm underline underline-offset-4 transition-colors font-sans">
                        Enviar intenciones para la Misa
                    </a>
                </div>
            </section>

            <!-- Tab: Rosario -->
            <section id="tab-rosario" class="hidden-tab max-w-3xl mx-auto space-y-8 animate-fade-in">
                <div class="p-6 md:p-10 rounded-[2.5rem] border glass shadow-2xl relative overflow-hidden">
                    <div id="rosaryProgress" class="absolute top-0 left-0 h-1 bg-amber-500 transition-all duration-500" style="width: 0%"></div>
                    <div class="flex justify-between items-center mb-8">
                        <div class="flex flex-col">
                            <span id="rosaryStepIndicator" class="text-[10px] font-bold uppercase tracking-[0.3em] text-amber-500 mb-1 font-sans"></span>
                            <h2 id="rosaryStepTitle" class="text-2xl font-bold"></h2>
                        </div>
                        <button onclick="resetRosary()" class="p-2 opacity-40 hover:opacity-100 transition-opacity">
                            <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="min-h-[250px] flex flex-col justify-center text-center px-4 overflow-y-auto">
                        <p id="rosaryInstruction" class="text-xs uppercase tracking-widest opacity-40 mb-6 font-bold font-sans"></p>
                        <p id="rosaryText" class="text-lg md:text-xl italic leading-relaxed font-light whitespace-pre-line"></p>
                        <div id="rosarySubPrayers" class="mt-8 space-y-4 hidden">
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-12 pt-8 border-t border-amber-500/10 font-sans">
                        <button id="rosaryPrev" onclick="moveRosary(-1)" class="flex items-center gap-2 text-xs uppercase tracking-widest font-bold hover:text-amber-500 transition-colors">
                            <i data-lucide="chevron-left" class="w-4 h-4"></i> Anterior
                        </button>
                        <button id="rosaryNext" onclick="moveRosary(1)" class="flex items-center gap-2 bg-amber-600 hover:bg-amber-500 text-white px-8 py-3 rounded-full text-xs uppercase tracking-widest font-bold transition-all shadow-lg">
                            Siguiente <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                <p id="rosaryDayInfo" class="text-center text-[10px] opacity-40 font-bold uppercase tracking-widest font-sans mt-4"></p>
            </section>

            <!-- Tab: Coronilla -->
            <section id="tab-coronilla" class="hidden-tab max-w-3xl mx-auto space-y-8 animate-fade-in">
                <div class="p-6 md:p-10 rounded-[2.5rem] border glass shadow-2xl relative overflow-hidden">
                    <div id="coronillaProgress" class="absolute top-0 left-0 h-1 bg-red-600 transition-all duration-500" style="width: 0%"></div>
                    <div class="flex justify-between items-center mb-8">
                        <div class="flex flex-col">
                            <span id="coronillaStepIndicator" class="text-[10px] font-bold uppercase tracking-[0.3em] text-red-500 mb-1 font-sans"></span>
                            <h2 id="coronillaStepTitle" class="text-2xl font-bold">La Divina Misericordia</h2>
                        </div>
                        <button onclick="resetCoronilla()" class="p-2 opacity-40 hover:opacity-100 transition-opacity">
                            <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="min-h-[250px] flex flex-col justify-center text-center px-4 overflow-y-auto">
                        <p id="coronillaInstruction" class="text-xs uppercase tracking-widest opacity-40 mb-6 font-bold font-sans"></p>
                        <p id="coronillaText" class="text-lg md:text-xl italic leading-relaxed font-light whitespace-pre-line"></p>
                        <div id="coronillaSubPrayers" class="mt-8 space-y-4 hidden">
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-12 pt-8 border-t border-amber-500/10 font-sans">
                        <button id="coronillaPrev" onclick="moveCoronilla(-1)" class="flex items-center gap-2 text-xs uppercase tracking-widest font-bold hover:text-red-500 transition-colors">
                            <i data-lucide="chevron-left" class="w-4 h-4"></i> Anterior
                        </button>
                        <button id="coronillaNext" onclick="moveCoronilla(1)" class="flex items-center gap-2 bg-red-700 hover:bg-red-600 text-white px-8 py-3 rounded-full text-xs uppercase tracking-widest font-bold transition-all shadow-lg">
                            Siguiente <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Tab: Misericordia -->
            <section id="tab-misericordia" class="hidden-tab max-w-5xl mx-auto space-y-12 animate-fade-in">
                <div class="text-center space-y-4">
                    <h2 class="text-4xl font-light italic">Obras de Misericordia</h2>
                    <p class="text-sm opacity-60 font-sans italic">"Porque tuve hambre, y me disteis de comer..." (Mt 25, 35)</p>
                </div>
                
                <div class="grid md:grid-cols-2 gap-12">
                    <!-- Corporales -->
                    <div class="space-y-6">
                        <h3 class="flex items-center gap-2 text-amber-500 font-bold uppercase tracking-widest text-sm border-b border-amber-500/20 pb-4 font-sans">
                            <i data-lucide="utensils" class="w-5 h-5"></i> Corporales
                        </h3>
                        <div id="corporalGrid" class="space-y-4">
                            <!-- JS Content -->
                        </div>
                    </div>
                    
                    <!-- Espirituales -->
                    <div class="space-y-6">
                        <h3 class="flex items-center gap-2 text-indigo-400 font-bold uppercase tracking-widest text-sm border-b border-indigo-400/20 pb-4 font-sans">
                            <i data-lucide="sparkles" class="w-5 h-5"></i> Espirituales
                        </h3>
                        <div id="spiritualGrid" class="space-y-4">
                            <!-- JS Content -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tab: Intención del Papa -->
            <section id="tab-papa" class="hidden-tab max-w-3xl mx-auto animate-fade-in">
                <div class="p-10 rounded-[3rem] border glass text-center space-y-8">
                    <div class="flex flex-col items-center">
                        <i data-lucide="globe" class="text-amber-500 w-12 h-12 mb-4"></i>
                        <h2 class="text-3xl font-light italic">Intención de Oración del Papa</h2>
                        <p id="papaMonthName" class="text-amber-600 font-bold uppercase tracking-widest text-xs mt-2 font-sans"></p>
                    </div>
                    
                    <div class="p-8 bg-amber-500/5 rounded-3xl border border-amber-500/10">
                        <p id="papaIntentionTitle" class="text-xl font-bold text-amber-100 mb-4"></p>
                        <p id="papaIntentionDesc" class="text-lg italic font-light leading-relaxed opacity-80"></p>
                    </div>

                    <div class="pt-6 border-t border-white/5">
                        <p class="text-[10px] uppercase tracking-widest opacity-40 font-bold font-sans">
                            Red Mundial de Oración del Papa
                        </p>
                    </div>
                </div>
            </section>

            <!-- Tab: Biblia -->
            <section id="tab-biblia" class="hidden-tab max-w-4xl mx-auto animate-fade-in">
                <div class="mb-6 flex items-center gap-4">
                    <button id="bibleBackBtn" onclick="bibleBack()" class="hidden flex items-center gap-2 text-xs uppercase tracking-widest opacity-60 hover:opacity-100 p-2 font-sans">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i> Volver
                    </button>
                    <h2 id="bibleTitle" class="text-xl font-bold">Sagradas Escrituras</h2>
                </div>
                <div id="bibleLibrary" class="space-y-10">
                </div>
                <div id="bibleChapters" class="hidden glass p-8 rounded-3xl border">
                    <p class="text-center opacity-60 mb-8 uppercase tracking-widest text-xs font-sans">Selecciona un capítulo</p>
                    <div id="chapterGrid" class="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-2 font-sans"></div>
                </div>
                <div id="bibleReader" class="hidden glass p-8 md:p-12 rounded-[2rem] border min-h-[400px]">
                    <div id="bibleLoading" class="flex flex-col items-center justify-center h-[300px] gap-4">
                        <i data-lucide="refresh-cw" class="w-8 h-8 animate-spin text-amber-500"></i>
                        <p class="text-xs uppercase tracking-widest animate-pulse font-sans">Consultando las escrituras...</p>
                    </div>
                    <div id="bibleContent" class="hidden max-w-2xl mx-auto">
                        <div class="mb-10 pb-6 border-b border-amber-500/10 flex justify-between items-end">
                            <h3 id="readingBookTitle" class="text-3xl font-bold"></h3>
                            <div class="flex gap-2 font-sans">
                                <button onclick="changeChapter(-1)" id="prevChapter" class="p-2 rounded-full hover:bg-amber-500/10"><i data-lucide="chevron-left"></i></button>
                                <button onclick="changeChapter(1)" id="nextChapter" class="p-2 rounded-full hover:bg-amber-500/10"><i data-lucide="chevron-right"></i></button>
                            </div>
                        </div>
                        <div id="readingText" class="text-xl leading-relaxed italic opacity-90 font-light space-y-6"></div>
                    </div>
                </div>
            </section>

            <!-- Tab: Peticiones -->
            <section id="tab-muro" class="hidden-tab max-w-2xl mx-auto space-y-6 animate-fade-in">
                <div class="p-8 rounded-3xl border glass font-sans">
                    <h3 class="text-lg font-bold mb-4">Muro de Peticiones</h3>
                    <div class="space-y-4">
                        <textarea id="prayerInput" placeholder="Escribe aquí tu intención..." class="w-full bg-slate-800/10 border border-amber-500/10 rounded-2xl p-4 outline-none h-28 text-sm focus:ring-1 focus:ring-amber-500 transition-all"></textarea>
                        <button onclick="savePrayer()" class="w-full bg-amber-600 text-white py-4 rounded-xl font-bold uppercase tracking-widest text-xs hover:bg-amber-500 transition-colors shadow-lg">Depositar petición</button>
                    </div>
                </div>
                <div id="prayersList" class="space-y-4">
                </div>
            </section>

        </div>
    </main>

    <footer class="fixed bottom-0 w-full p-4 border-t border-amber-500/10 bg-inherit z-50 backdrop-blur-md">
        <div class="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center px-4 gap-2 text-[10px] uppercase tracking-widest opacity-60 font-bold font-sans">
            <div class="flex items-center gap-2"><i data-lucide="sparkles" class="text-amber-500 w-3 h-3"></i> Católica del Norte</div>
            <div class="italic text-center">"Todo lo puedo en Aquel que me fortalece"</div>
        </div>
    </footer>

    <script>
        // Configuración y Datos
        const apiKey = ""; 
        let currentTheme = 'dark';
        let currentTab = 'altar';
        
        const candles = [
            { id: 1, label: 'Almas del Purgatorio', prayer: 'Que la luz perpetua las ilumine en su descanso eterno. Amén.' },
            { id: 2, label: 'Salud de los Enfermos', prayer: 'Señor Jesús, visita a los que sufren y dales tu alivio soberano. Amén.' },
            { id: 3, label: 'Por las Familias', prayer: 'Sagrada Familia, haz de nuestros hogares iglesias domésticas de paz. Amén.' },
            { id: 4, label: 'Paz en el Mundo', prayer: 'Haz de mí un instrumento de tu paz donde hay guerra. Amén.' },
            { id: 5, label: 'Acción de Gracias', prayer: 'Te damos gracias por el don de la vida y tu amor sin fin. Amén.' },
        ];

        const misericordiaData = {
            corporales: [
                { title: "Visitar a los enfermos", tip: "Llamar o visitar a quien esté pasando por un mal momento de salud." },
                { title: "Dar de comer al hambriento", tip: "Compartir alimentos con los necesitados o bancos de comida." },
                { title: "Dar de beber al sediento", tip: "Cuidar el agua y colaborar en proyectos de acceso a ella." },
                { title: "Dar posada al peregrino", tip: "Acoger y orientar con calidez a los nuevos compañeros o extranjeros." },
                { title: "Vestir al desnudo", tip: "Donar ropa en buen estado a fundaciones o personas necesitadas." },
                { title: "Visitar a los presos", tip: "Rezar por la libertad espiritual y conversión de quienes están cautivos." },
                { title: "Enterrar a los difuntos", tip: "Acompañar con caridad y oración a las familias que atraviesan un duelo." }
            ],
            espirituales: [
                { title: "Enseñar al que no sabe", tip: "Ayudar a un compañero con temas académicos difíciles o compartir conocimientos." },
                { title: "Dar buen consejo", tip: "Escuchar con empatía y orientar con valores cristianos a quien pide ayuda." },
                { title: "Corregir al que yerra", tip: "Hacer observaciones fraternas siempre desde el amor y la mansedumbre." },
                { title: "Perdonar las injurias", tip: "Soltar rencores y buscar la reconciliación tras un conflicto." },
                { title: "Consolar al triste", tip: "Dedicar tiempo a escuchar a alguien que se siente solo o desanimado." },
                { title: "Sufrir con paciencia los defectos", tip: "Tener tolerancia con las limitaciones ajenas en el día a día." },
                { title: "Rogar por los vivos y difuntos", tip: "Orar diariamente por las intenciones del mundo y la salvación de las almas." }
            ]
        };

        const oraciones = {
            padreNuestro: "Padre nuestro, que estás en el cielo, santificado sea tu Nombre; venga a nosotros tu reino; hágase tu voluntad en la tierra como en el cielo. Danos hoy nuestro pan de cada día; perdona nuestras ofensas, como también nosotros perdonamos a los que nos ofenden; no nos dejes caer en la tentación, y líbranos del mal. Amén.",
            aveMaria: "Dios te salve, María, llena eres de gracia, el Señor es contigo. Bendita tú eres entre todas las mujeres y benedito es el fruto de tu vientre, Jesús. Santa María, Madre de Dios, ruega por nosotros, pecadores, ahora y en la hora de nuestra muerte. Amén.",
            gloria: "Gloria al Padre, y al Hijo, y al Espíritu Santo. Como era en el principio, ahora y siempre, por los siglos de los siglos. Amén.",
            fatima: "¡Oh Jesús mío! Perdona nuestros pecados, líbranos del fuego del infierno, lleva al cielo a todas las almas, especialmente a las más necesitadas de tu divina misericordia. Amén.",
            salve: "Dios te salve, Reina y Madre de misericordia, vida, dulzura y esperanza nuestra; Dios te salve. A ti llamamos los desterrados hijos de Eva; a ti suspiramos, gimiendo y llorando, en este valle de lágrimas. Ea, pues, Señora, abogada nuestra, vuelve a nosotros esos tus ojos misericordiosos; y después de este destierro muéstranos a Jesús, fruto bendito de tu vientre. ¡Oh clementísima, oh piadosa, oh dulce siempre Virgen María! Ruega por nosotros, Santa Madre de Dios. Amén.",
            credo: "Creo en Dios, Padre Todopoderoso, Creador del cielo y de la tierra. Creo en Jesucristo, su único Hijo, Nuestro Señor, que fue concebido por obra y gracia del Espíritu Santo, nació de Santa María Virgen, padeció bajo el poder de Poncio Pilato, fue crucificado, muerto y sepultado, descendió a los infiernos, al tercer día resucitó de entre los muertos, subió a los cielos y está sentado a la derecha de Dios, Padre Todopoderoso. Desde allí ha de venir a juzgar a vivos y muertos. Creo en el Espíritu Santo, la santa Iglesia Católica, la comunión de los santos, el perdón de los pecados, la resurrección de la carne y la vida eterna. Amén."
        };

        const misteriosLibro = {
            gozosos: ["La Encarnación del Hijo de Dios", "La Visitación de María a su prima Santa Isabel", "El Nacimiento del Hijo de Dios en el portal de Belén", "La Purificación de la Virgen y Presentación del Niño Jesús en el Templo", "El Niño Jesús perdido y hallado en el Templo"],
            dolorosos: ["La Oración de Jesús en el Huerto de los Olivos", "La Flagelación de Nuestro Señor Jesucristo", "La Coronación de Espinas", "Jesús carga con la Cruz camino del Calvario", "La Crucifixión y Muerte de Nuestro Señor"],
            gloriosos: ["La Triunfante Resurrección de Jesús", "La Ascensión de Jesús al Cielo", "La Venida del Espíritu Santo sobre los Apóstoles", "La Asunción de la Virgen María en cuerpo y alma al cielo", "La Coronación de María como Reina de todo lo creado"],
            luminosos: ["El Bautismo de Jesús en el Jordán", "La Autorrevelación de Jesús en las bodas de Caná", "El Anuncio del Reino de Dios invitando a la conversión", "La Transfiguración del Señor", "La Institución de la Eucaristía"]
        };

        const papaIntentions = [
            { month: "Enero", title: "Por los educadores", desc: "Oremos para que los educadores sean testigos creíbles, enseñando la fraternidad en lugar de la confrontación y ayudando especialmente a los jóvenes más vulnerables." },
            { month: "Febrero", title: "Por los enfermos terminales", desc: "Oremos para que los enfermos terminales y sus familias reciban siempre los cuidados y el acompañamiento necesarios, tanto desde el punto de vista médico como humano." },
            { month: "Marzo", title: "Por los nuevos mártires", desc: "Oremos para que quienes en diversas partes del mundo arriesgan su vida por el Evangelio contagien a la Iglesia su valentía y su impulso misionero." },
            { month: "Abril", title: "Por el papel de la mujer", desc: "Oremos para que la dignidad y la riqueza de las mujeres sean reconocidas en todas las culturas, y para que cese la discriminación que sufren en diversas partes del mundo." },
            { month: "Mayo", title: "Por la formación de religiosos y seminaristas", desc: "Oremos para que los religiosos, las religiosas y los seminaristas crezcan en su camino vocacional a través de una formación humana, pastoral, espiritual y comunitaria." },
            { month: "Junio", title: "Por los que huyen de su país", desc: "Oremos para que los migrantes que huyen de las guerras o del hambre, obligados a viajes llenos de peligro y violencia, encuentren aceptación y nuevas oportunidades de vida." },
            { month: "Julio", title: "Por los ancianos", desc: "Oremos para que los ancianos, que representan las raíces y la memoria de un pueblo, sean valorados por su experiencia y sabiduría, y para que su testimonio ayude a los jóvenes a mirar el futuro con esperanza." },
            { month: "Agosto", title: "Por los líderes políticos", desc: "Oremos para que los líderes políticos estén al servicio de su propio pueblo, trabajando por el desarrollo humano integral y el bien común, atendiendo a los que han perdido su empleo y dando prioridad a los más pobres." },
            { month: "Septiembre", title: "Por el clamor de la Tierra", desc: "Oremos para que cada uno de nosotros escuche con el corazón el clamor de la Tierra y de las víctimas de las catástrofes ambientales y de la crisis climática." },
            { month: "Octubre", title: "Por una misión compartida", desc: "Oremos para que la Iglesia siga apoyando por todos los medios un estilo de vida sinodal, bajo el signo de la corresponsabilidad, fomentando la participación, la comunión y la misión compartida." },
            { month: "Noviembre", title: "Por quienes han perdido un hijo", desc: "Oremos para que todos los padres que lloran la muerte de un hijo o una hija encuentren apoyo en la comunidad y obtengan del Espíritu Consolador la paz del corazón." },
            { month: "Diciembre", title: "Por los voluntarios", desc: "Oremos para que las organizaciones de voluntariado y de promoción humana encuentren personas deseosas de comprometerse con el bien común y busquen caminos siempre nuevos de colaboración a nivel internacional." }
        ];

        const coronillaSequence = [
            { title: "Inicio", instruction: "Haz la Señal de la Cruz", text: "Por la señal de la Santa Cruz, de nuestros enemigos líbranos, Señor, Dios nuestro. En el nombre del Padre, y del Hijo, y del Espíritu Santo. Amén." },
            { title: "Oraciones Iniciales", instruction: "Reza el Padre Nuestro, Ave María y Credo", text: "Padre Nuestro...\nAve María...\nCredo de los Apóstoles..." },
            { title: "Decena 1", instruction: "Cuentas de la Coronilla", isCoronillaDecena: true },
            { title: "Decena 2", instruction: "Cuentas de la Coronilla", isCoronillaDecena: true },
            { title: "Decena 3", instruction: "Cuentas de la Coronilla", isCoronillaDecena: true },
            { title: "Decena 4", instruction: "Cuentas de la Coronilla", isCoronillaDecena: true },
            { title: "Decena 5", instruction: "Cuentas de la Coronilla", isCoronillaDecena: true },
            { title: "Conclusión", instruction: "Repite 3 veces", text: "Santo Dios, Santo Fuerte, Santo Inmortal, ten piedad de nosotros y del mundo entero." },
            { title: "Jaculatoria Final", instruction: "En Ti confío", text: "Oh Sangre y Agua que brotaste del Corazón de Jesús como una fuente de misericordia para nosotros, en Ti confío.\n\nJesús, en Ti confío." }
        ];

        const bibleData = {
            "Nuevo Testamento": [
                { name: "Mateo", chapters: 28, isGospel: true }, { name: "Marcos", chapters: 16, isGospel: true }, { name: "Lucas", chapters: 24, isGospel: true }, { name: "Juan", chapters: 21, isGospel: true },
                { name: "Hechos", chapters: 28 }, { name: "Romanos", chapters: 16 }, { name: "1 Corintios", chapters: 16 }, { name: "2 Corintios", chapters: 13 },
                { name: "Gálatas", chapters: 6 }, { name: "Efesios", chapters: 6 }, { name: "Filipenses", chapters: 4 }, { name: "Colosenses", chapters: 4 },
                { name: "1 Tesalonicenses", chapters: 5 }, { name: "2 Tesalonicenses", chapters: 3 }, { name: "1 Timoteo", chapters: 6 }, { name: "2 Timoteo", chapters: 4 },
                { name: "Tito", chapters: 3 }, { name: "Filemón", chapters: 1 }, { name: "Hebreos", chapters: 13 }, { name: "Santiago", chapters: 5 },
                { name: "1 Pedro", chapters: 5 }, { name: "2 Pedro", chapters: 3 }, { name: "1 Juan", chapters: 5 }, { name: "2 Juan", chapters: 1 }, { name: "3 Juan", chapters: 1 },
                { name: "Judas", chapters: 1 }, { name: "Apocalipsis", chapters: 22 }
            ],
            "Antiguo Testamento": [
                { name: "Génesis", chapters: 50 }, { name: "Éxodo", chapters: 40 }, { name: "Levítico", chapters: 27 }, { name: "Números", chapters: 36 }, { name: "Deuteronomio", chapters: 34 },
                { name: "Josué", chapters: 24 }, { name: "Jueces", chapters: 21 }, { name: "Rut", chapters: 4 }, { name: "1 Samuel", chapters: 31 }, { name: "2 Samuel", chapters: 24 },
                { name: "1 Reyes", chapters: 22 }, { name: "2 Reyes", chapters: 25 }, { name: "1 Crónicas", chapters: 29 }, { name: "2 Crónicas", chapters: 36 }, { name: "Esdras", chapters: 10 },
                { name: "Nehemías", chapters: 13 }, { name: "Ester", chapters: 10 }, { name: "Job", chapters: 42 }, { name: "Salmos", chapters: 150 }, { name: "Proverbios", chapters: 31 }, 
                { name: "Eclesiastés", chapters: 12 }, { name: "Cantares", chapters: 8 }, { name: "Isaías", chapters: 66 }, { name: "Jeremías", chapters: 52 },
                { name: "Lamentaciones", chapters: 5 }, { name: "Ezequiel", chapters: 48 }, { name: "Daniel", chapters: 14 }, { name: "Oseas", chapters: 14 },
                { name: "Joel", chapters: 3 }, { name: "Amós", chapters: 9 }, { name: "Abdías", chapters: 1 }, { name: "Jonás", chapters: 4 }, { name: "Miqueas", chapters: 7 },
                { name: "Nahúm", chapters: 3 }, { name: "Habacuc", chapters: 3 }, { name: "Sofonías", chapters: 3 }, { name: "Ageo", chapters: 2 }, { name: "Zacarías", chapters: 14 }, { name: "Malaquías", chapters: 4 }
            ]
        };

        const bookMapping = { "Cantares": "Song of Solomon" }; 

        // Estado App
        let litCandles = new Set();
        let rosaryStep = 0;
        let coronillaStep = 0;
        let selectedBook = null;
        let selectedChapter = 1;
        let peticiones = JSON.parse(localStorage.getItem('peticiones') || '[]');

        // Inicialización
        window.onload = () => {
            lucide.createIcons();
            renderCandles();
            renderBibleLibrary();
            renderPrayers();
            renderMisericordia();
            updateRosary();
            updateCoronilla();
            updatePapaIntention();
            setupTheme();
        };

        // Navegación
        function switchTab(tabId) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden-tab'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden-tab');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-tab'));
            const clickedBtn = Array.from(document.querySelectorAll('.nav-btn')).find(b => b.getAttribute('onclick').includes(tabId));
            if(clickedBtn) clickedBtn.classList.add('active-tab');
            currentTab = tabId;
        }

        // Altar
        function renderCandles() {
            const grid = document.getElementById('candlesGrid');
            grid.innerHTML = candles.map(c => {
                const isLit = litCandles.has(c.id);
                const waxColors = ['#fffdf2', '#fff9e6', '#fefcf0'];
                const waxColor = waxColors[c.id % waxColors.length];

                return `
                <div class="candle-container">
                    <button onclick="toggleCandle(${c.id})" class="flex flex-col items-center group relative">
                        <div class="relative h-32 flex flex-col items-center justify-end">
                            <div class="absolute top-0 w-16 h-16 bg-amber-400/20 rounded-full blur-xl transition-opacity duration-1000 ${isLit ? 'opacity-100' : 'opacity-0'}"></div>
                            
                            <div class="relative ${isLit ? '' : 'hidden'}">
                                <div class="candle-wick"></div>
                                <div id="flame-${c.id}" class="candle-flame"></div>
                            </div>

                            <div class="candle-body ${isLit ? 'glow-effect' : ''}" 
                                 style="background: radial-gradient(circle at 50% 0%, ${isLit ? '#fff' : waxColor} 0%, ${waxColor} 100%); 
                                        opacity: ${isLit ? '1' : '0.6'}; 
                                        box-shadow: ${isLit ? 'inset -2px 0 5px rgba(0,0,0,0.05), 0 0 20px rgba(251,191,36,0.1)' : 'none'};">
                                <div class="w-full h-1 bg-black/5 rounded-full mt-1"></div>
                            </div>
                        </div>
                        <span class="mt-4 text-[10px] font-bold uppercase tracking-widest transition-colors duration-500 ${isLit ? 'text-amber-500' : 'opacity-40 group-hover:opacity-100'}">${c.label}</span>
                    </button>
                </div>
                `;
            }).join('');
        }

        function toggleCandle(id) {
            if (litCandles.has(id)) {
                litCandles.delete(id);
                document.getElementById('candlePrayer').classList.add('hidden');
            } else {
                litCandles.add(id);
                const candle = candles.find(c => c.id === id);
                document.getElementById('candlePrayer').classList.remove('hidden');
                document.getElementById('prayerText').innerText = `"${candle.prayer}"`;
            }
            renderCandles();
        }

        // Misericordia
        function renderMisericordia() {
            const corpGrid = document.getElementById('corporalGrid');
            const spirGrid = document.getElementById('spiritualGrid');
            
            corpGrid.innerHTML = misericordiaData.corporales.map(o => `
                <div class="p-5 glass rounded-2xl border border-amber-500/10 hover:border-amber-500/30 transition-all text-left">
                    <h4 class="text-amber-500 font-bold mb-1 font-sans">${o.title}</h4>
                    <p class="text-sm opacity-70 italic font-light">${o.tip}</p>
                </div>
            `).join('');

            spirGrid.innerHTML = misericordiaData.espirituales.map(o => `
                <div class="p-5 glass rounded-2xl border border-indigo-400/10 hover:border-indigo-400/30 transition-all text-left">
                    <h4 class="text-indigo-400 font-bold mb-1 font-sans">${o.title}</h4>
                    <p class="text-sm opacity-70 italic font-light">${o.tip}</p>
                </div>
            `).join('');
        }

        // Rosario
        function getMisteriosHoy() {
            const day = new Date().getDay();
            if (day === 1 || day === 6) return { tipo: "Gozosos", lista: misteriosLibro.gozosos };
            if (day === 2 || day === 5) return { tipo: "Dolorosos", lista: misteriosLibro.dolorosos };
            if (day === 3 || day === 0) return { tipo: "Gloriosos", lista: misteriosLibro.gloriosos };
            return { tipo: "Luminosos", lista: misteriosLibro.luminosos };
        }

        function getRosarySequence() {
            const misterios = getMisteriosHoy();
            const seq = [
                { title: "Inicio", instruction: "Señal de la Cruz", text: "Por la señal de la Santa Cruz, de nuestros enemigos líbranos, Señor, Dios nuestro. En el nombre del Padre, y del Hijo, y del Espíritu Santo. Amén." },
                { title: "Acto de Contrición", instruction: "Pide perdón", text: "Jesús, mi Señor y Redentor, yo me arrepiento de todos los pecados que he cometido hasta hoy, y me pesa de todo corazón, porque con ellos he ofendido a un Dios tan bueno. Propongo firmemente no volver a pecar y confío que por tu infinita misericordia me has de conceder el perdón de mis culpas y me has de llevar a la vida eterna. Amén." }
            ];
            
            misterios.lista.forEach((m, i) => {
                seq.push({
                    title: `Misterio ${i + 1}`,
                    instruction: `Meditemos el Misterio ${misterios.tipo}`,
                    text: m,
                    isMystery: true
                });
            });

            seq.push({ title: "La Salve", instruction: "Oración final", text: oraciones.salve });
            seq.push({ title: "Finalización", instruction: "Bajo tu amparo", text: "Bajo tu amparo nos acogemos, santa Madre de Dios; no deseches las súplicas que te dirigimos en nuestras necesidades, antes bien, líbranos de todo peligro, ¡oh Virgen siempre gloriosa y benedicta! Amén." });
            
            return seq;
        }

        function updateRosary() {
            const seq = getRosarySequence();
            const step = seq[rosaryStep];
            const progressEl = document.getElementById('rosaryProgress');
            const indicatorEl = document.getElementById('rosaryStepIndicator');
            const titleEl = document.getElementById('rosaryStepTitle');
            const instructionEl = document.getElementById('rosaryInstruction');
            const textEl = document.getElementById('rosaryText');
            const dayInfoEl = document.getElementById('rosaryDayInfo');

            if (progressEl) progressEl.style.width = `${(rosaryStep / (seq.length - 1)) * 100}%`;
            if (indicatorEl) indicatorEl.innerText = `Paso ${rosaryStep + 1} de ${seq.length}`;
            if (titleEl) titleEl.innerText = step.title;
            if (instructionEl) instructionEl.innerText = step.instruction;
            if (textEl) textEl.innerText = step.text;
            if (dayInfoEl) dayInfoEl.innerText = `Hoy es ${new Intl.DateTimeFormat('es-ES', { weekday: 'long' }).format(new Date())}: Misterios ${getMisteriosHoy().tipo}`;

            const subContainer = document.getElementById('rosarySubPrayers');
            if (subContainer) {
                if (step.isMystery) {
                    subContainer.classList.remove('hidden');
                    subContainer.innerHTML = `
                        <div class="p-4 bg-amber-500/5 rounded-2xl border border-amber-500/10 text-left glass">
                            <p class="text-[10px] uppercase font-bold opacity-60 mb-2 font-sans">En cada misterio:</p>
                            <div class="space-y-4">
                                <div><p class="text-[10px] font-bold text-amber-500 uppercase mb-1">Padre Nuestro</p><p class="text-xs opacity-80 italic">${oraciones.padreNuestro}</p></div>
                                <div><p class="text-[10px] font-bold text-amber-500 uppercase mb-1">Ave María (10 veces)</p><p class="text-xs opacity-80 italic">${oraciones.aveMaria}</p></div>
                                <div><p class="text-[10px] font-bold text-amber-500 uppercase mb-1">Gloria y Jaculatoria</p><p class="text-xs opacity-80 italic">${oraciones.gloria}\n\n${oraciones.fatima}</p></div>
                            </div>
                        </div>
                    `;
                } else {
                    subContainer.classList.add('hidden');
                }
            }

            const prevBtn = document.getElementById('rosaryPrev');
            if (prevBtn) prevBtn.disabled = rosaryStep === 0;
            
            const nextBtn = document.getElementById('rosaryNext');
            if (nextBtn) {
                nextBtn.innerText = rosaryStep === seq.length - 1 ? 'Terminar' : 'Siguiente';
                nextBtn.onclick = rosaryStep === seq.length - 1 ? resetRosary : () => moveRosary(1);
            }
        }

        function moveRosary(dir) {
            rosaryStep += dir;
            updateRosary();
        }

        function resetRosary() {
            rosaryStep = 0;
            updateRosary();
        }

        // Coronilla
        function updateCoronilla() {
            const step = coronillaSequence[coronillaStep];
            const progressEl = document.getElementById('coronillaProgress');
            const indicatorEl = document.getElementById('coronillaStepIndicator');
            const titleEl = document.getElementById('coronillaStepTitle');
            const instructionEl = document.getElementById('coronillaInstruction');
            const textEl = document.getElementById('coronillaText');

            if (progressEl) progressEl.style.width = `${(coronillaStep / (coronillaSequence.length - 1)) * 100}%`;
            if (indicatorEl) indicatorEl.innerText = `Paso ${coronillaStep + 1} de ${coronillaSequence.length}`;
            if (titleEl) titleEl.innerText = step.title;
            if (instructionEl) instructionEl.innerText = step.instruction;
            
            if (step.isCoronillaDecena) {
                if (textEl) textEl.innerText = "Misterio de la Misericordia";
            } else {
                if (textEl) textEl.innerText = step.text;
            }

            const subContainer = document.getElementById('coronillaSubPrayers');
            if (subContainer) {
                if (step.isCoronillaDecena) {
                    subContainer.classList.remove('hidden');
                    subContainer.innerHTML = `
                        <div class="p-4 bg-red-500/5 rounded-2xl border border-red-500/10 text-left glass">
                            <p class="text-[10px] uppercase font-bold opacity-60 mb-2 font-sans">En cada decena:</p>
                            <div class="space-y-4">
                                <div><p class="text-[10px] font-bold text-red-500 uppercase mb-1">Cuenta Grande (1 vez)</p>
                                <p class="text-xs opacity-80 italic">"Padre Eterno, te ofrezco el Cuerpo y la Sangre, el Alma y la Divinidad de Tu Amadísimo Hijo, Nuestro Señor Jesucristo, como propiciación de nuestros pecados y los del mundo entero."</p></div>
                                <div><p class="text-[10px] font-bold text-red-500 uppercase mb-1">Cuentas Pequeñas (10 veces)</p>
                                <p class="text-xs opacity-80 italic">"Por Su dolorosa Pasión, ten misericordia de nosotros y del mundo entero."</p></div>
                            </div>
                        </div>
                    `;
                } else if (step.title === "Oraciones Iniciales") {
                    subContainer.classList.remove('hidden');
                    subContainer.innerHTML = `
                        <div class="space-y-4 text-left p-4 glass rounded-2xl border border-white/5 max-h-[300px] overflow-y-auto">
                            <div><p class="text-[10px] font-bold text-amber-500 uppercase">Padre Nuestro</p><p class="text-xs opacity-70 italic">${oraciones.padreNuestro}</p></div>
                            <div><p class="text-[10px] font-bold text-amber-500 uppercase">Ave María</p><p class="text-xs opacity-70 italic">${oraciones.aveMaria}</p></div>
                            <div><p class="text-[10px] font-bold text-amber-500 uppercase">Credo</p><p class="text-xs opacity-70 italic">${oraciones.credo}</p></div>
                        </div>
                    `;
                } else {
                    subContainer.classList.add('hidden');
                }
            }

            const prevBtn = document.getElementById('coronillaPrev');
            if (prevBtn) prevBtn.disabled = coronillaStep === 0;
            
            const nextBtn = document.getElementById('coronillaNext');
            if (nextBtn) {
                nextBtn.innerText = coronillaStep === coronillaSequence.length - 1 ? 'Terminar' : 'Siguiente';
                nextBtn.onclick = coronillaStep === coronillaSequence.length - 1 ? resetCoronilla : () => moveCoronilla(1);
            }
        }

        function moveCoronilla(dir) {
            coronillaStep += dir;
            updateCoronilla();
        }

        function resetCoronilla() {
            coronillaStep = 0;
            updateCoronilla();
        }

        // Intención del Papa
        function updatePapaIntention() {
            const currentMonthIndex = new Date().getMonth();
            const intention = papaIntentions[currentMonthIndex];
            
            document.getElementById('papaMonthName').innerText = intention.month;
            document.getElementById('papaIntentionTitle').innerText = intention.title;
            document.getElementById('papaIntentionDesc').innerText = intention.desc;
        }

        // Biblia
        function renderBibleLibrary() {
            const lib = document.getElementById('bibleLibrary');
            lib.innerHTML = Object.entries(bibleData).map(([test, books]) => `
                <div>
                    <h3 class="text-amber-500 uppercase tracking-widest text-xs font-bold mb-6 border-b border-amber-500/10 pb-2 font-sans">${test}</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                        ${books.map(b => `
                            <button onclick="openBook('${b.name}', ${b.chapters})" 
                                    class="p-4 rounded-xl border glass hover:border-amber-500 transition-all text-sm text-left font-bold font-sans relative flex flex-col justify-between h-full ${b.isGospel ? 'gospel-highlight' : ''}">
                                <div class="flex justify-between items-start">
                                    <span>${b.name}</span>
                                    ${b.isGospel ? '<i data-lucide="sparkles" class="w-3 h-3 text-amber-500"></i>' : ''}
                                </div>
                                ${b.isGospel ? '<span class="text-[8px] uppercase tracking-tighter text-amber-600 mt-2">Evangelio</span>' : ''}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function openBook(name, chapters) {
            selectedBook = { name, chapters };
            document.getElementById('bibleLibrary').classList.add('hidden');
            document.getElementById('bibleChapters').classList.remove('hidden');
            document.getElementById('bibleBackBtn').classList.remove('hidden');
            document.getElementById('bibleTitle').innerText = name;
            
            const grid = document.getElementById('chapterGrid');
            grid.innerHTML = Array.from({ length: chapters }, (_, i) => i + 1).map(num => `
                <button onclick="readChapter(${num})" class="w-full aspect-square flex items-center justify-center rounded-lg border border-slate-700/50 hover:bg-amber-500 hover:text-white transition-all text-sm font-bold">
                    ${num}
                </button>
            `).join('');
        }

        function bibleBack() {
            const lib = document.getElementById('bibleLibrary');
            const chapters = document.getElementById('bibleChapters');
            const reader = document.getElementById('bibleReader');

            if (!reader.classList.contains('hidden')) {
                reader.classList.add('hidden');
                chapters.classList.remove('hidden');
            } else {
                chapters.classList.add('hidden');
                lib.classList.remove('hidden');
                document.getElementById('bibleBackBtn').classList.add('hidden');
                document.getElementById('bibleTitle').innerText = "Sagradas Escrituras";
            }
        }

        async function readChapter(num) {
            selectedChapter = num;
            document.getElementById('bibleChapters').classList.add('hidden');
            document.getElementById('bibleReader').classList.remove('hidden');
            document.getElementById('bibleLoading').classList.remove('hidden');
            document.getElementById('bibleContent').classList.add('hidden');

            const bookForApi = bookMapping[selectedBook.name] || selectedBook.name;
            
            try {
                const res = await fetch(`https://bible-api.com/${bookForApi} ${num}?translation=rv1909`);
                if (!res.ok) throw new Error();
                const data = await res.json();
                displayBibleText(data.text);
            } catch {
                displayBibleText("Error al cargar el texto sagrado. Por favor, revisa tu conexión.");
            }
        }

        function displayBibleText(text) {
            document.getElementById('bibleLoading').classList.add('hidden');
            document.getElementById('bibleContent').classList.remove('hidden');
            document.getElementById('readingBookTitle').innerText = `${selectedBook.name} ${selectedChapter}`;
            document.getElementById('readingText').innerText = text;
        }

        function changeChapter(dir) {
            const target = selectedChapter + dir;
            if (target > 0 && target <= selectedBook.chapters) {
                readChapter(target);
            }
        }

        // Muro de Peticiones
        function renderPrayers() {
            const list = document.getElementById('prayersList');
            list.innerHTML = peticiones.map(p => `
                <div class="p-5 rounded-2xl border glass border-l-4 border-l-amber-500 animate-fade-in">
                    <p class="text-sm italic font-light">"${p.text}"</p>
                    <span class="text-[10px] opacity-40 mt-2 block font-bold uppercase tracking-widest font-sans">${p.date}</span>
                </div>
            `).join('');
        }

        function savePrayer() {
            const text = document.getElementById('prayerInput').value;
            if (text.trim()) {
                const p = { id: Date.now(), text, date: new Date().toLocaleDateString() };
                peticiones.unshift(p);
                localStorage.setItem('peticiones', JSON.stringify(peticiones));
                document.getElementById('prayerInput').value = '';
                renderPrayers();
            }
        }

        // Theme
        function setupTheme() {
            const btn = document.getElementById('themeToggle');
            btn.onclick = () => {
                currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.body.className = currentTheme === 'dark' 
                    ? 'bg-slate-950 text-slate-200 min-h-screen pb-20 overflow-x-hidden' 
                    : 'bg-stone-50 text-stone-900 min-h-screen pb-20 overflow-x-hidden light';
                document.getElementById('themeIcon').setAttribute('data-lucide', currentTheme === 'dark' ? 'sun' : 'moon');
                lucide.createIcons();
            };
        }
    </script>
</body>
</html>
